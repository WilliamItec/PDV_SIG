CREATE VIEW V_CUPOMFISCAL
AS 
SELECT 
	1 as cd_emp,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.origem as cd_filial,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_ESTACAO as cd_cx,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.DATA_CAIXA as dt_vd,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.DATA_CAIXA as dt_cad,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.HORA_OPERACAO AS HR_VD,
    0 AS NR_ORC,
    0 AS NR_PED_TELEVD,
    0 as ORIGEM_ORC,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA AS CD_VD,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA AS NR_ECF,
    0 AS ST_VD,
    200 AS CONTADOR_CUPOM_FISCAL,
    4.0 AS CODIGO_MOVIMENTO,
    NULL AS CGC_FILIAL,
    NULL AS NM_FILIAL,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_CLIENTE AS CD_CLI,
    SIG_POS_dbo.MTZ_CLIENTES.CPF AS CGC_CLI,
    SIG_POS_dbo.MTZ_CLIENTES.NOME AS NM_CLI,
    0 AS NUMERO_CARTAO,
    COALESCE(SIG_POS_dbo.MTZ_CLIENTES.ID_EMPRESA,'0') AS CD_CONV,
    NULL CD_CLI_CONV,
    NULL AS CGC_CONV,
    NULL NM_CONV,
    0 AS DIAS_PRORROG_CONV,
    (SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR - SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO) AS VLR_LIQ_VD,
    (SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR - SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO) AS VLR_TOT_PROD,
    (SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR -SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO)AS VLR_VD,
    0 AS VLR_DESC,
    0 AS VLR_DESC_ITENS,
    SIG_POS_dbo.V_REC_MOEDAS.VLR_DINH,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO,
    SIG_POS_dbo.V_REC_MOEDAS.VLR_CONV,
	(CASE WHEN SIG_POS_dbo.V_REC_MOEDAS.VLR_CONV > 0 THEN 
			1
		ELSE 
			0
	END) AS QT_PARC_CONV,
    0 AS CD_CTR_NCC,
    0 AS VLR_NCC,    
    0 AS VLR_DUP,
    0 AS VLR_CHQS_A_VISTA,
    0 AS VLR_CHQS_A_PRZ,
    0 AS NR_CEL_RECARGA,

	(CASE WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento LIKE '%VIVO%' THEN 
		(SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR -SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO)
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%CLARO%' THEN 
		(SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR -SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO)
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%TIM%' THEN 
		(SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR -SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO)
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%OI%' THEN 
		(SIG_POS_dbo.POS_NOTAS_TOTAIS.VALOR -SIG_POS_dbo.POS_NOTAS_TOTAIS.TROCO)
	ELSE
		0
	END) AS VLR_RECARGA_CEL,
	(CASE WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento LIKE '%VIVO%' THEN 
		'VIVO' 
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%CLARO%' THEN 
		'CLARO'
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%TIM%' THEN 
		'TIM'
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%OI%' THEN 
		'OI'
	ELSE
		''
	END) AS NM_OPERADORA,
	SIG_POS_dbo.MTZ_CLIENTES.NOME AS NM_COMPRADOR,    
    '' AS DADOS_ADICIONAIS,
    
    '1.0' AS VERSAO_PDV,
    '1.0' AS VERSAO_PDV_RC,
    (CASE WHEN SIG_POS_dbo.V_REC_MOEDAS.VLR_DINH>0 THEN
		'TRUE'
	ELSE
		'FALSE'
	END) AS CONTEM_DINHEIRO,
    (CASE WHEN SIG_POS_dbo.V_REC_MOEDAS.VLR_CONV >0 THEN
		'TRUE'
	ELSE
		'FALSE'
	END) AS CONTEM_CONVENIO,    
	'FALSE' as CONTEM_DUPLICATA,    
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_ESTACAO AS NR_SERIE_ECF,
    
	(CASE WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento LIKE '%VIVO%' THEN 
		'TRUE'
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%CLARO%' THEN 
		'TRUE'
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%TIM%' THEN 
		'TRUE'
	WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.documento like '%OI%' THEN 
		'TRUE'
	ELSE
		'FALSE'
	END) AS CONTEM_RECARGA_CEL, 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_USER AS CD_OPERADOR,
    REPLACE(REPLACE(REPLACE(SIG_POS_dbo.POS_USERS.DESCRICAO,'*',''),'#',''),'@','') AS NM_OPERADOR,
    SIG_POS_dbo.V_REC_MOEDAS.VLR_CONV_PBM,
    0 AS CD_OUTRO_PROCEDIMENTO,
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_USER AS CD_USU_PROCEDIMENTO,
    0 AS REGISTROALTERADO,
    
    
    0 AS CD_USU_CANCEL,
    '' AS NM_USU_CANCEL,
    0 AS CODIGO_MOTIVO_CANCELAMENTO,
    0 AS IS_CANCELADO,
    0 AS IS_CANCELADO_PAF,
    0 AS ST_CANC_PAF,
    0  AS CANCEL_NFCE,
    '' AS XML_CANCEL,
    0 AS TP_CANC,
    '' AS CHV_NFCE_CANCEL,
    '' AS DT_EMIS_CANCEL,
    '' AS AUT_CANC,
    '' AS DS_MOTIVO_CANCEL,
    
    
    
    0 AS CD_CLI_PBM,
    0 AS IS_DEBITAR_PONTOS,
    0 AS VALOR_IBPT,
    0 AS PERCENTUAL_IBPT,
    0 AS CD_NF_SAI,
    
    
    0 AS FLAG_CONSOLIDADO,
    FALSE AS CONTEM_NCC,
    1 AS FLAG_NFCE
FROM 
	SIG_POS_dbo.POS_NOTAS_TOTAIS LEFT join SIG_POS_dbo.MTZ_CLIENTES on
    SIG_POS_dbo.POS_NOTAS_TOTAIS.id_cliente=SIG_POS_dbo.MTZ_CLIENTES.id_cliente INNER JOIN SIG_POS_dbo.V_REC_MOEDAS ON 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA=SIG_POS_dbo.V_REC_MOEDAS.ID_NOTA LEFT JOIN SIG_POS_dbo.POS_USERS ON 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_USER=SIG_POS_dbo.POS_USERS.ID_USER
WHERE
	SIG_POS_dbo.POS_NOTAS_TOTAIS.STATUS='C';
