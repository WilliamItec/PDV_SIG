create view v_cupomfiscal_pbm 
AS 
 SELECT 
	1 AS CD_EMP,
	SIG_POS_dbo.POS_NOTAS_TOTAIS.ORIGEM as CD_FILIAL,
	SIG_POS_dbo.POS_NOTAS_TOTAIS.DATA_CAIXA as DT_VD,
	SIG_POS_dbo.POS_NOTAS_TOTAIS.DATA_CAIXA AS DT_CAD,
	SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_ESTACAO as CD_CX,
	SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA AS CD_VD, 
	SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA AS NR_ECF, 
	(CASE WHEN SIG_POS_dbo.POS_NOTAS_TOTAIS.STATUS='C' THEN 
		0 
	ELSE
		1
	END) as ST_VD,
    0 AS CD_CONV,    
	'' AS NM_CONV,    
	(CASE WHEN SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (376, 317280) THEN
		6
	WHEN SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (317279, 122473) THEN
		2
	WHEN SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (222370, 222371,317277) THEN
		3
	WHEN SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (296896) THEN
		5
	WHEN SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (317278) THEN
		1
	END) AS TIPO_PBM,
		
	'' AS CGC_CONV,        
	SIG_POS_dbo.V_REC_MOEDAS.VLR_CONV_PBM AS VLR_CONV,    
	'' AS CD_AUTORIZACAO,
	1 AS CD_IT,    
    (SELECT MAX(P_CODIGO) FROM SIG_POS_dbo.POS_NOTAS_DETALHES INNER JOIN SIG_POS_dbo.POS_NOTAS_TOTAIS ON SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA=SIG_POS_dbo.POS_NOTAS_DETALHES.ID_NOTA LIMIT 1) AS CD_PROD,
	0 AS VLR_PROD_CLI,
	0 AS VLR_PROD_REEMBOL,
	0 AS VLR_PROD_CONV,
	pdv_vd.FLAG_CONSOLIDADO
FROM 
	SIG_POS_dbo.POS_NOTAS_TOTAIS INNER JOIN SIG_POS_dbo.V_REC_MOEDAS ON 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA=SIG_POS_dbo.V_REC_MOEDAS.ID_NOTA INNER JOIN SIG_POS_dbo.POS_RECEBIMENTOS ON 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA=SIG_POS_dbo.POS_RECEBIMENTOS.ID_NOTA INNER JOIN pdv_vd ON 
    SIG_POS_dbo.POS_NOTAS_TOTAIS.ID_NOTA=pdv_vd.CD_VD
  WHERE 
    SIG_POS_dbo.POS_RECEBIMENTOS.ID_MOEDA=4 AND
    SIG_POS_dbo.POS_RECEBIMENTOS.ID_AUXILIAR IN (376,122473,222370,222371,296896,317277,317278,317279,317280,317450);
